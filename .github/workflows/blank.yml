name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    container:
      image: lua:5.4
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install linting tools
      run: |
        apt-get update && apt-get install -y luarocks
        luarocks install luacheck
        luarocks install lua-format
        
    - name: Run Lua linting
      run: |
        echo "üîç Running Lua linting..."
        luacheck --config .luacheckrc .
        
    - name: Check code formatting
      run: |
        echo "üé® Checking code formatting..."
        # Create a backup of original files
        find . -name "*.lua" -exec cp {} {}.bak \;
        
        # Apply formatting
        find . -name "*.lua" -exec lua-format -i {} \;
        
        # Check if any files were modified
        if ! git diff --exit-code; then
          echo "‚ùå Code formatting issues detected!"
          echo "The following files need formatting:"
          git diff --name-only
          exit 1
        fi
        echo "‚úÖ Code formatting is correct!"