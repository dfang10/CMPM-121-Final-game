name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y lua5.4 liblua5.4-dev build-essential
        
    - name: Install LuaRocks
      run: |
        wget https://luarocks.org/releases/luarocks-3.9.2.tar.gz
        tar zxpf luarocks-3.9.2.tar.gz
        cd luarocks-3.9.2
        ./configure --with-lua-include=/usr/include/lua5.4
        make && sudo make install
        cd ..
        
    - name: Install linting tools
      run: |
        sudo luarocks install luacheck
        sudo luarocks install lua-format
        
    - name: Run Lua linting
      run: |
        echo "üîç Running Lua linting..."
        luacheck --config .luacheckrc .
        
    - name: Check code formatting
      run: |
        echo "üé® Checking code formatting..."
        # Create a backup of original files
        find . -name "*.lua" -exec cp {} {}.bak \;
        
        # Apply formatting
        find . -name "*.lua" -exec lua-format -i {} \;
        
        # Check if any files were modified
        if git diff --exit-code; then
          echo "‚úÖ Code formatting is correct!"
        else
          echo "‚ùå Code formatting issues detected!"
          echo "The following files need formatting:"
          git diff --name-only
          echo ""
          echo "To fix locally, run:"
          echo "  make format"
          echo "Or install pre-commit hooks:"
          echo "  pre-commit install"
          exit 1
        fi
        
    - name: Cleanup backups
      run: |
        find . -name "*.lua.bak" -delete