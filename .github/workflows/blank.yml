name: Code Quality Check

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Lua
      uses: leafo/gh-actions-lua@v8
      with:
        luaVersion: 5.4
        
    - name: Install linting tools
      run: |
        luarocks install luacheck
        luarocks install lua-format
        
    - name: Run Lua linting
      run: |
        echo "üîç Running Lua linting..."
        luacheck --config .luacheckrc .
        
    - name: Check code formatting
      run: |
        echo "üé® Checking code formatting..."
        # Create a backup of original files
        find . -name "*.lua" -exec cp {} {}.bak \;
        
        # Apply formatting
        find . -name "*.lua" -exec lua-format -i {} \;
        
        # Check if any files were modified
        if git diff --exit-code; then
          echo "‚úÖ Code formatting is correct!"
        else
          echo "‚ùå Code formatting issues detected!"
          echo "The following files need formatting:"
          git diff --name-only
          echo ""
          echo "To fix locally, run:"
          echo "  make format"
          echo "Or install pre-commit hooks:"
          echo "  pre-commit install"
          exit 1
        fi
        
    - name: Cleanup backups
      run: |
        find . -name "*.lua.bak" -delete